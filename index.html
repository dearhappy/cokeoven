<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scaffolding Checkout</title>
<style>
body{font-family:Arial;background:#f4f6f8}
.card{max-width:420px;margin:auto;background:#fff;padding:15px;border-radius:10px}
input,select,button{width:100%;padding:8px;margin:5px 0}
table{width:100%;font-size:12px}
</style>
</head>
<body>

<div class="card" id="login">
<h3>Supervisor Login</h3>
<select id="user"></select>
<input type="password" id="pass" placeholder="Passcode">
<button onclick="login()">Login</button>
</div>

<div class="card" id="app" style="display:none">
<h3>Scaffolding Checkout</h3>

<input id="sheetNo" placeholder="Sheet No">
<input id="permitNo" placeholder="Permit No">
<input type="date" id="date">
<select id="jobType">
<option>Erection</option>
<option>Dismantling</option>
</select>
<input id="area" placeholder="Area">
<input id="location" placeholder="Location">
<select id="dept"></select>
<select id="stype"></select>
<select id="elev"></select>

<input id="len" placeholder="Length">
<input id="wid" placeholder="Width">
<input id="ht" placeholder="Height">
<input id="qty" placeholder="Qty">

<button onclick="addEntry()">Add Measurement</button>

<table border="1" id="tbl"></table>

<input id="manpower" placeholder="Total Manpower">

<button onclick="submitData()">SUBMIT</button>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbzIDUZhawrZmd_8qvqDclP-E6oQt32HvXSQQQq_hCs7Bz_z-6MuiPwkxovKibJvrm-s/exec";

let users=[], entries=[], supervisor="";

fetch(WEB_APP_URL).then(r=>r.json()).then(d=>{
  users=d.users;
  d.users.forEach(u=>{
    user.innerHTML+=`<option>${u[0]}</option>`;
  });
  d.departments.forEach(v=>dept.innerHTML+=`<option>${v}</option>`);
  d.scaffoldTypes.forEach(v=>stype.innerHTML+=`<option>${v}</option>`);
  d.elevations.forEach(v=>elev.innerHTML+=`<option>${v}</option>`);
});

function login(){
  const u=user.value,p=pass.value;
  const ok=users.find(r=>r[0]==u && r[1]==p);
  if(!ok){alert("Invalid");return;}
  supervisor=u;
  login.style.display="none";
  app.style.display="block";
}

function addEntry(){
  const L=+len.value,W=+wid.value,H=+ht.value,Q=+qty.value;
  let vol=L*W*H*Q;
  if(jobType.value=="Dismantling") vol=vol/2;

  entries.push({
    sheetNo:sheetNo.value,
    permitNo:permitNo.value,
    date:date.value,
    jobType:jobType.value,
    area:area.value,
    location:location.value,
    department:dept.value,
    scaffoldType:stype.value,
    elevation:elev.value,
    length:L,width:W,height:H,qty:Q,volume:vol
  });

  tbl.innerHTML+=`<tr><td>${jobType.value}</td><td>${vol.toFixed(2)}</td></tr>`;
}

function submitData(){
  const totalE=entries.filter(e=>e.jobType=="Erection").reduce((a,b)=>a+b.volume,0);
  const totalD=entries.filter(e=>e.jobType=="Dismantling").reduce((a,b)=>a+b.volume,0);
  const mh=manpower.value*10;
  const prod=((totalE+totalD)/mh).toFixed(2);

  const report=
`Date: ${date.value}
Supervisor: ${supervisor}
Area: ${area.value}
Total Erection: ${totalE.toFixed(2)}
Total Dismantling: ${totalD.toFixed(2)}
Total Manhours: ${mh}
Productivity: ${prod}`;

  navigator.clipboard.writeText(report);
  alert("Report copied to clipboard");

  fetch(WEB_APP_URL,{
    method:"POST",
    body:JSON.stringify({supervisor,entries})
  }).then(()=>location.reload());
}
</script>
</body>
</html>
