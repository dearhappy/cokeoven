<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Check-Out</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body { background-color: #f3f4f6; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans text-gray-800">

    <script>
        // PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIDUZhawrZmd_8qvqDclP-E6oQt32HvXSQQQq_hCs7Bz_z-6MuiPwkxovKibJvrm-s/exec';
    </script>

    <div class="max-w-md mx-auto min-h-screen bg-white shadow-xl overflow-hidden relative">
        
        <div class="bg-blue-800 text-white p-4 text-center">
            <h1 class="text-xl font-bold">JOB COMPLETION TRACKER</h1>
            <p class="text-xs opacity-75">Supervisor Check-Out</p>
        </div>

        <div id="loadingView" class="p-10 text-center hidden">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
            <p>Loading...</p>
        </div>

        <div id="loginView" class="p-6">
            <h2 class="text-lg font-bold mb-4 text-center">Supervisor Login</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">Supervisor Name</label>
                    <select id="loginUser" class="w-full border p-2 rounded bg-gray-50"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">Passcode</label>
                    <input type="password" id="loginPass" class="w-full border p-2 rounded" placeholder="Enter passcode">
                </div>
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">LOGIN</button>
            </div>
        </div>

        <div id="formView" class="hidden pb-20">
            <div class="p-4 bg-gray-50 border-b space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="sheetNo" placeholder="Sheet No." class="border p-2 rounded text-sm w-full">
                    <input type="text" id="permitNo" placeholder="Permit No." class="border p-2 rounded text-sm w-full">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="date" id="entryDate" class="border p-2 rounded text-sm w-full">
                    <input type="text" id="area" placeholder="Area" class="border p-2 rounded text-sm w-full">
                </div>
                <input type="text" id="location" placeholder="Specific Location" class="border p-2 rounded text-sm w-full">
            </div>

            <div id="measurementsContainer" class="p-2 space-y-3"></div>

            <div class="p-2 text-center">
                <button onclick="addMeasurementRow()" class="text-blue-600 font-bold text-sm">+ Add Measurement Entry</button>
            </div>

            <div class="p-4 border-t bg-gray-100">
                <label class="block text-xs font-bold text-gray-500">TOTAL MANPOWER</label>
                <input type="number" id="totalManpower" class="border p-2 w-full rounded mb-4" placeholder="Enter headcount">
                
                <button onclick="submitData()" class="w-full bg-green-600 text-white py-3 rounded font-bold shadow-lg">
                    SUBMIT & GENERATE REPORT
                </button>
            </div>
        </div>

        <div id="reportView" class="hidden p-4">
            
            <div id="jpegCapture" class="bg-white border-2 border-gray-800 p-4 mb-6">
                <div class="text-center border-b-2 border-gray-800 pb-2 mb-2">
                    <h2 class="text-2xl font-bold text-blue-900">JOB SUMMARY</h2>
                    <p class="text-sm text-gray-600" id="reportDate"></p>
                </div>
                
                <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                    <div>
                        <span class="block text-gray-500 text-xs">SUPERVISOR</span>
                        <span class="font-bold" id="reportSupervisor"></span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs">AREA</span>
                        <span class="font-bold" id="reportArea"></span>
                    </div>
                </div>

                <div class="bg-gray-100 p-3 rounded mb-4 space-y-2">
                    <div class="flex justify-between">
                        <span>Total Erection (m³):</span>
                        <span class="font-bold text-blue-700" id="reportErection">0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Dismantling (m³):</span>
                        <span class="font-bold text-red-700" id="reportDismantling">0.00</span>
                    </div>
                    <div class="border-t border-gray-300 my-1"></div>
                    <div class="flex justify-between">
                        <span>Manpower:</span>
                        <span class="font-bold" id="reportManpower">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Manhours:</span>
                        <span class="font-bold" id="reportManhours">0</span>
                    </div>
                </div>

                <div class="text-center p-2 border-2 border-blue-900 text-blue-900 font-bold rounded">
                    PRODUCTIVITY: <span id="reportProductivity" class="text-xl">0.00</span>
                </div>
                <p class="text-center text-[10px] text-gray-400 mt-2">Generated via JobTracker App</p>
            </div>

            <div class="space-y-3">
                <button onclick="copyToWhatsapp()" class="w-full bg-green-500 text-white py-3 rounded flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp"></i> Copy Text for WhatsApp
                </button>
                <button onclick="downloadJpeg()" class="w-full bg-blue-600 text-white py-3 rounded flex items-center justify-center gap-2">
                    <i class="fas fa-image"></i> Download Image Report
                </button>
                <button onclick="location.reload()" class="w-full border border-gray-400 text-gray-600 py-3 rounded">
                    Close & New Entry
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let dropdownData = {};
        let currentUser = "";

        // --- INIT ---
        window.onload = async function() {
            document.getElementById('entryDate').valueAsDate = new Date();
            toggleView('loadingView');
            await fetchDropdowns();
            toggleView('loginView');
        };

        function toggleView(viewId) {
            ['loadingView', 'loginView', 'formView', 'reportView'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        // --- API CALLS ---
        async function fetchDropdowns() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getLists`);
                dropdownData = await res.json();
                
                // Populate Supervisor Login
                const userSelect = document.getElementById('loginUser');
                dropdownData.supervisors.forEach(u => {
                    let opt = document.createElement('option');
                    opt.value = u;
                    opt.innerText = u;
                    userSelect.appendChild(opt);
                });
            } catch (e) {
                alert("Error connecting to server. Check URL.");
            }
        }

        async function handleLogin() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            
            toggleView('loadingView');
            
            try {
                const res = await fetch(`${SCRIPT_URL}?action=login&user=${encodeURIComponent(user)}&pass=${encodeURIComponent(pass)}`);
                const data = await res.json();
                
                if (data.result === 'success') {
                    currentUser = user;
                    toggleView('formView');
                    addMeasurementRow(); // Add first empty row
                } else {
                    alert("Invalid Credentials");
                    toggleView('loginView');
                }
            } catch (e) {
                alert("Login Error");
                toggleView('loginView');
            }
        }

        // --- FORM LOGIC ---
        function addMeasurementRow() {
            const container = document.getElementById('measurementsContainer');
            const id = Date.now();
            
            let deptOptions = dropdownData.departments.map(d => `<option value="${d}">${d}</option>`).join('');
            let typeOptions = dropdownData.scaffoldTypes.map(t => `<option value="${t}">${t}</option>`).join('');
            let elevOptions = dropdownData.elevations.map(e => `<option value="${e}">${e}</option>`).join('');

            const html = `
            <div id="row-${id}" class="bg-white p-3 rounded shadow-sm border border-gray-200 relative measurement-row">
                <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-red-500 font-bold px-2">&times;</button>
                
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <select class="border p-2 rounded text-sm w-full field-action">
                        <option value="ERECTION">Erection</option>
                        <option value="DISMANTLING">Dismantling</option>
                    </select>
                    <select class="border p-2 rounded text-sm w-full field-dept">
                        <option value="" disabled selected>Dept</option>
                        ${deptOptions}
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-2">
                    <select class="border p-2 rounded text-sm w-full field-type">
                        <option value="" disabled selected>Type</option>
                        ${typeOptions}
                    </select>
                    <select class="border p-2 rounded text-sm w-full field-elev">
                        <option value="" disabled selected>Elevation</option>
                        ${elevOptions}
                    </select>
                </div>

                <div class="grid grid-cols-5 gap-1">
                    <input type="number" placeholder="L" class="border p-1 rounded text-sm w-full field-l">
                    <input type="number" placeholder="W" class="border p-1 rounded text-sm w-full field-w">
                    <input type="number" placeholder="H" class="border p-1 rounded text-sm w-full field-h">
                    <input type="number" placeholder="Qty" class="border p-1 rounded text-sm w-full field-q">
                    <input type="text" readonly placeholder="Vol" class="bg-gray-100 border p-1 rounded text-sm w-full text-center font-bold field-vol">
                </div>
            </div>`;
            
            container.insertAdjacentHTML('beforeend', html);

            // Add event listeners for auto-calc per row
            const row = document.getElementById(`row-${id}`);
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(inp => inp.addEventListener('input', () => calculateRow(row)));
        }

        function calculateRow(row) {
            const l = parseFloat(row.querySelector('.field-l').value) || 0;
            const w = parseFloat(row.querySelector('.field-w').value) || 0;
            const h = parseFloat(row.querySelector('.field-h').value) || 0;
            const q = parseFloat(row.querySelector('.field-q').value) || 0;
            const action = row.querySelector('.field-action').value;
            
            let vol = l * w * h * q;
            if (action === 'DISMANTLING') vol = vol / 2;
            
            row.querySelector('.field-vol').value = vol.toFixed(2);
        }

        async function submitData() {
            // Validation
            const manpower = document.getElementById('totalManpower').value;
            if(!manpower) return alert("Please enter Total Manpower");

            toggleView('loadingView');

            // Gather Data
            const rows = document.querySelectorAll('.measurement-row');
            let measurements = [];
            let totalErection = 0;
            let totalDismantling = 0;

            rows.forEach(r => {
                let vol = parseFloat(r.querySelector('.field-vol').value) || 0;
                let action = r.querySelector('.field-action').value;
                
                if(action === 'ERECTION') totalErection += vol;
                else totalDismantling += vol;

                measurements.push({
                    type: action,
                    department: r.querySelector('.field-dept').value,
                    scaffoldType: r.querySelector('.field-type').value,
                    elevation: r.querySelector('.field-elev').value,
                    length: r.querySelector('.field-l').value,
                    width: r.querySelector('.field-w').value,
                    height: r.querySelector('.field-h').value,
                    qty: r.querySelector('.field-q').value
                });
            });

            const payload = {
                header: {
                    sheetNo: document.getElementById('sheetNo').value,
                    permitNo: document.getElementById('permitNo').value,
                    date: document.getElementById('entryDate').value,
                    area: document.getElementById('area').value,
                    location: document.getElementById('location').value,
                    supervisor: currentUser,
                    manpower: manpower
                },
                measurements: measurements
            };

            // Calculate Finals for Report
            const totalManhours = manpower * 10;
            const productivity = totalManhours > 0 ? (totalErection + totalDismantling) / totalManhours : 0;

            // Submit to Google Sheet
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                // Populate Report View
                document.getElementById('reportDate').innerText = payload.header.date;
                document.getElementById('reportSupervisor').innerText = currentUser;
                document.getElementById('reportArea').innerText = payload.header.area;
                document.getElementById('reportErection').innerText = totalErection.toFixed(2);
                document.getElementById('reportDismantling').innerText = totalDismantling.toFixed(2);
                document.getElementById('reportManpower').innerText = manpower;
                document.getElementById('reportManhours').innerText = totalManhours;
                document.getElementById('reportProductivity').innerText = productivity.toFixed(2);

                toggleView('reportView');

            } catch (e) {
                alert("Submission Failed");
                toggleView('formView');
            }
        }

        // --- REPORTING ---
        function copyToWhatsapp() {
            const date = document.getElementById('reportDate').innerText;
            const sup = document.getElementById('reportSupervisor').innerText;
            const area = document.getElementById('reportArea').innerText;
            const ere = document.getElementById('reportErection').innerText;
            const dis = document.getElementById('reportDismantling').innerText;
            const mh = document.getElementById('reportManhours').innerText;
            const prod = document.getElementById('reportProductivity').innerText;

            const text = `*JOB COMPLETION REPORT*\nDate: ${date}\nSupervisor: ${sup}\nArea: ${area}\n\nTotal Erection: ${ere} m3\nTotal Dismantling: ${dis} m3\nTotal Manhours: ${mh}\nProductivity: ${prod}\n\nSubmitted via Web App`;

            navigator.clipboard.writeText(text).then(() => {
                alert("Report copied to clipboard! Opening WhatsApp...");
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            });
        }

        function downloadJpeg() {
            const element = document.getElementById("jpegCapture");
            html2canvas(element).then(canvas => {
                const link = document.createElement('a');
                link.download = `Report_${Date.now()}.jpg`;
                link.href = canvas.toDataURL("image/jpeg");
                link.click();
            });
        }
    </script>
</body>
</html>
